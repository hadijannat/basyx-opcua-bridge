services:
  mosquitto:
    image: eclipse-mosquitto:2.0
    ports:
      - "${MQTT_HOST_PORT:-1883}:1883"
    volumes:
      - ./mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
    healthcheck:
      test: ["CMD", "mosquitto_pub", "-h", "localhost", "-t", "healthcheck", "-m", "ok"]
      interval: 5s
      timeout: 3s
      retries: 12

  mqtt-wait:
    image: eclipse-mosquitto:2.0
    depends_on:
      mosquitto:
        condition: service_healthy
    command: >
      sh -c "until mosquitto_pub -h mosquitto -t healthcheck -m ok >/dev/null 2>&1; do sleep 1; done"

  sm-repo:
    image: ${SM_REPO_IMAGE:-eclipsebasyx/submodel-repository:2.0.0-SNAPSHOT}
    ports:
      - "8081:8080"
    environment:
      SERVER_PORT: 8080
    volumes:
      - ./basyx/submodel-repo.properties:/application/application.properties:ro
    restart: on-failure
    depends_on:
      mqtt-wait:
        condition: service_completed_successfully

  opcua-simulator:
    build:
      context: ./opcua-simulator
    ports:
      - "4840:4840"

  bridge:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    volumes:
      - ../config/bridge.e2e.yaml:/app/config/bridge.yaml:ro
    depends_on:
      - mosquitto
      - sm-repo
      - opcua-simulator
