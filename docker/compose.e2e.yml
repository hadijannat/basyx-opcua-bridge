services:
  mosquitto:
    image: eclipse-mosquitto:2.0
    ports:
      - "1883:1883"
    healthcheck:
      test: ["CMD", "mosquitto_sub", "-h", "localhost", "-t", "$SYS/broker/uptime", "-C", "1", "-W", "1"]
      interval: 5s
      timeout: 3s
      retries: 12

  sm-repo:
    image: ${SM_REPO_IMAGE:-eclipsebasyx/submodel-repository:2.0.0-SNAPSHOT}
    ports:
      - "8081:8080"
    environment:
      SERVER_PORT: 8080
      BASYX_BACKEND: InMemory
      BASYX_SMREPO_NAME: sm-repo
      BASYX_SUBMODELREPOSITORY_FEATURE_MQTT_ENABLED: "true"
      MQTT_CLIENTID: sm-repo-e2e
      MQTT_HOSTNAME: mosquitto
      MQTT_PORT: 1883
    restart: on-failure
    depends_on:
      mosquitto:
        condition: service_healthy

  opcua-simulator:
    build:
      context: ./opcua-simulator
    ports:
      - "4840:4840"

  bridge:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    volumes:
      - ../config/bridge.e2e.yaml:/app/config/bridge.yaml:ro
    depends_on:
      - mosquitto
      - sm-repo
      - opcua-simulator
